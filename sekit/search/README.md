# Search
EIOにより実験結果が保存されたJSONファイルを集約して、CSV形式に変換するツールです。

## まず動かしてみる。
1. 本リポジトリの`examples`内にある`search_inputs`フォルダとその中身を任意の場所に保存する。

2. `search_inputs`フォルダのある場所に移動する。

3. 以下のコマンドを実行する。
```
python -m sekit.search search_inputs/*.json > search_output.csv
```
4. `search_output.csv `に実行結果が保存されているので確認します。
```
$ cat search_output.csv
,_header,_seed,activation,hidden_layer_sizes,validation_fraction,|,goro,hoge,piyo,_process_time,_filename
0,sample,1310594.0,relu,"[100, 200]",0.1,|,___relu___,600.43511624812,0.9403189928133333,2.5510787963867188e-05,"sample,a=relu,hls=100_200,vf=0.1,_s=1310594.json"
1,sample,8464620.0,relu,"[100, 200]",0.1,|,___relu___,600.0944444683364,1.2068970555777847,2.3365020751953125e-05,"sample,a=relu,hls=100_200,vf=0.1,_s=8464620.json"
2,sample,6400996.0,relu,[300],0.1,|,___relu___,600.2177963090445,0.3982820513584382,2.288818359375e-05,"sample,a=relu,hls=300,vf=0.1,_s=6400996.json"
3,sample,9667937.0,relu,[300],0.1,|,___relu___,600.7429092878614,0.41764986261200676,2.193450927734375e-05,"sample,a=relu,hls=300,vf=0.1,_s=9667937.json"
4,sample,3246075.0,relu,"[500, 500, 500]",0.4,|,___relu___,3001.4014718764633,1.5745036227868974,2.1457672119140625e-05,"sample,a=relu,hls=500_500_500,vf=0.4,_s=3246075.json"
5,sample,7901026.0,relu,"[500, 500, 500]",0.4,|,___relu___,3001.2393623552925,1.2297033417783192,2.5987625122070312e-05,"sample,a=relu,hls=500_500_500,vf=0.4,_s=7901026.json"
6,sample,5168185.0,relu,"[500, 500, 500]",0.5,|,___relu___,3001.0257777747875,2.27902365301889,2.5033950805664062e-05,"sample,a=relu,hls=500_500_500,vf=0.5,_s=5168185.json"
7,sample,7587603.0,relu,"[500, 500, 500]",0.5,|,___relu___,3001.217828590123,2.3094741094577635,2.1219253540039062e-05,"sample,a=relu,hls=500_500_500,vf=0.5,_s=7587603.json"
8,sample,1881864.0,tanh,"[100, 200]",0.1,|,___tanh___,600.995475021502,0.9392883331993762,2.9802322387695312e-05,"sample,a=tanh,hls=100_200,vf=0.1,_s=1881864.json"
9,sample,2971965.0,tanh,"[100, 200]",0.1,|,___tanh___,601.4229930136728,0.5645295203575379,2.574920654296875e-05,"sample,a=tanh,hls=100_200,vf=0.1,_s=2971965.json"
10,sample,2715881.0,tanh,[300],0.1,|,___tanh___,600.4125244895451,1.1058198220772304,2.5272369384765625e-05,"sample,a=tanh,hls=300,vf=0.1,_s=2715881.json"
11,sample,8256549.0,tanh,[300],0.1,|,___tanh___,600.373664527264,0.30975114085611066,2.1696090698242188e-05,"sample,a=tanh,hls=300,vf=0.1,_s=8256549.json"
```

`search_inputs`フォルダの中には、EIOにより保存された、パラメータと対応した実験結果がJSONとして複数保存されています。
searchにより、12件の実験結果がひとつのCSVファイルに集約されました。
search_inputs内の実験結果であるJSONの一例は以下の通りです。

```json
{
    "_header": "sample",
    "_param": {
        "_seed": 1310594,
        "activation": "relu",
        "hidden_layer_sizes": [
            100,
            200
        ],
        "validation_fraction": 0.1
    },
    "_process_time": 2.5510787963867188e-05,
    "giro": [
        300.9559435305069,
        600.0159616691503
    ],
    "goro": "___relu___",
    "hoge": 600.43511624812,
    "piyo": 0.9403189928133333
}
```
このうち、実験のパラメータに当たる部分は以下の2つです
- `_header`: 実験名
- `_param`: 実験パラメータの組み合わせ

実験結果は
- `giro`
- `goro`
- `hoge`
- `piyo`
- `_process_time`

です。これらのうち、アンダーバー`_`のついたものはEIOにより自動で組み込まれた値で、searchの処理では特別な扱いを受けています。
- `_header`: 出力の先頭列に来ます
- `_param`: この中のキーと値がパラメータ名とその値として、`_header`列の右の列にキーでソートされて組み込まれます
- `_process_time`: 実験結果の一番右の列として組み込まれます。


また、CSVの最右列に`_filename`という列があります。
これは、その実験結果JSONのファイル名を表しています。

## キャッシュ機能
ツールのオプションで`--cache <CSV Filename>`とすると、すでにあるCSVファイルに追加することができます。
このとき、実験結果JSONファイルのファイル名(`_filename`)がかぶるものは読み込まれません。

## コマンドのオプション
- `--display`: 処理中の表示をONにします
- `-o` or `--output`: 標準出力せずにファイルを保存する際のファイル名
- `--dir`: 引数でファイル名を渡さずにディレクトリ名で指定するためのオプション。対象としたディレクトリ内のjsonファイルを読み込むようになる。ファイル数が多すぎて引数にできない場合に用いる。
- `--param_key`: 実験結果JSONファイル内のパラメータのキー。デフォルトは`_param`
- `--filename_key`: 実験結果JSONファイル名を記載する列名。 デフォルトは`_filename`
- `--head_columns`: 列を並び替えCSVの左側に持ってくる列名を指定する。デフォルトは`_header`のみ。
- `--tail_columns`: 列を並び替えCSVの右側に持ってくる列名を指定する。デフォルトは`_process_time`と`_filename`のみ。
- `--separator`: 実験パラメータと実験結果を区切る列に入れる文字列. デフォルトは `|`
- `--cache`: キャッシュもとになるCSVのパス
